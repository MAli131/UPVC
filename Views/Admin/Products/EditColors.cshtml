@model UPVC.Models.Product
@{
    ViewData["Title"] = "إدارة الألوان";
    Layout = "~/Views/Admin/Shared/_AdminLayout.cshtml";
    var productDetails = Model.ProductDetails;
    var productColors = productDetails?.Colors?.OrderBy(pc => pc.DisplayOrder).ToList() ?? new List<UPVC.Models.ProductColor>();
}

<!-- Info Box -->
<div class="row mb-2">
    <div class="col-12">
        <div class="info-box bg-gradient-warning" style="min-height: 70px;">
            <span class="info-box-icon" style="width: 70px; height: 70px; line-height: 70px;">
                <i class="fas fa-palette" style="font-size: 1.8rem;"></i>
            </span>
            <div class="info-box-content">
                <span class="info-box-text" style="font-size: 0.9rem;">إدارة الألوان - @Model.NameAr</span>
                <span class="info-box-number" style="font-size: 1.2rem;">@productColors.Count لون</span>
            </div>
        </div>
    </div>
</div>

<!-- Back Button -->
<div class="row mb-2">
    <div class="col-12">
        <a asp-action="Index" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-right"></i> العودة للقائمة
        </a>
    </div>
</div>

<!-- Main Layout -->
<div class="row">
    @foreach (var pc in productColors)
    {
        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
            <div class="card @(pc.IsActive ? "card-success" : "card-secondary") card-outline">
                <div class="card-body text-center" style="padding: 1rem;">
                    <!-- Color Preview -->
                    <div style="width: 80px; height: 80px; margin: 0 auto 0.75rem; border-radius: 50%; border: 3px solid #ddd; background-color: @pc.Color?.HexCode;"></div>
                    
                    <!-- Color Names -->
                    <h5 style="font-size: 0.95rem; margin-bottom: 0.5rem;">@pc.Color?.NameAr</h5>
                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">@pc.Color?.NameEn</p>
                    <p style="font-size: 0.75rem; color: #999; margin-bottom: 0.75rem;">@pc.Color?.HexCode</p>
                    
                    <!-- Toggle Switch -->
                    <div class="custom-control custom-switch" style="display: inline-block;">
                        <input type="checkbox" 
                               class="custom-control-input color-toggle" 
                               id="color@(pc.Id)" 
                               data-id="@pc.Id"
                               data-color-id="@pc.ColorId"
                               @(pc.IsActive ? "checked" : "")
                               onchange="toggleColor(this)">
                        <label class="custom-control-label" for="color@(pc.Id)" style="font-size: 0.85rem;">
                            @(pc.IsActive ? "نشط" : "غير نشط")
                        </label>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@if (!productColors.Any())
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> لا توجد ألوان لهذا المنتج
    </div>
}

<div class="row mt-2">
    <div class="col-12">
        <div class="callout callout-info" style="padding: 0.5rem 0.75rem;">
            <p style="margin: 0; font-size: 0.8rem;">
                <i class="fas fa-info-circle"></i>
                <strong>ملاحظة:</strong>
                يمكنك فقط تفعيل أو إلغاء تفعيل الألوان لهذا المنتج (إظهار/إخفاء).
                الألوان نفسها محفوظة ولا يمكن تعديلها من هنا.
            </p>
        </div>
    </div>
</div>

<script>
var currentProductDetailsId = @(productDetails?.Id ?? 0);

function toggleColor(checkbox) {
    var colorId = checkbox.getAttribute('data-color-id');
    var isActive = checkbox.checked;
    var card = checkbox.closest('.card');
    var label = checkbox.nextElementSibling;

    // Send AJAX request
    fetch('/Admin/Products/ToggleColor', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        },
        body: 'productDetailsId=' + currentProductDetailsId + '&colorId=' + colorId + '&isActive=' + isActive
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update card styling
            if (isActive) {
                card.classList.remove('card-secondary');
                card.classList.add('card-success');
                label.textContent = 'نشط';
            } else {
                card.classList.remove('card-success');
                card.classList.add('card-secondary');
                label.textContent = 'غير نشط';
            }
            
            showToast('success', data.message);
        } else {
            // Revert checkbox on error
            checkbox.checked = !isActive;
            showToast('error', data.message);
        }
    })
    .catch(error => {
        checkbox.checked = !isActive;
        showToast('error', 'حدث خطأ أثناء الحفظ');
        console.error('Error:', error);
    });
}

function showToast(type, message) {
    alert(message);
}
</script>

@Html.AntiForgeryToken()
